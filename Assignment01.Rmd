---
title: "**Geospatial Data Sciences and Economic Spatial Models**  \n_Assignment 01_\n"
author: "**1. Alejandro Delgado**  \n**2. Enzo Infantes**  \n**3. Tarang Kadyan**\n"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: false
    code_download: true
    number_sections: true
  pdf_document:
    toc: false
bibliography: references.bib
csl: apa.csl 
---

![](C:/Users/Enzo/Pictures/bse_logo.png){width="50%"}

# **Introducction**

For this document, we are going to replicate maps in academic publications/working papers in economics. The main goal of this work is to put in practice the sf tools to work with vector data.

# **Development**

In this section there are all the maps that we replicated and, previously, the codes we used to obtained them.

We are calling the libraries we will use.

```{r setup, message=FALSE, warning=FALSE}
library(sf)
library(ggplot2)
library(spData)
library(dplyr)
library(foreign)
library(ggrepel)
library(viridis)
library(tidyverse)
library(readxl)

no_axis <- theme(axis.title=element_blank(),
                 axis.text=element_blank(),
                 axis.ticks=element_blank())

no_axis_legend <- theme(axis.title=element_blank(),
                        axis.text=element_blank(),
                        axis.ticks=element_blank(), legend.position="bottom")

loop_list <- c("uf1940","meso")


setwd("C:/Users/Enzo/Documents/BSE/T2/GEOSPATIAL_SPATIAL_MODELS/S03/HW")
path <- getwd()
path_data <- file.path(path, "data") 
```

## Hydro dams in South Africa

From [@mettetal2019].

```{r setup, message=FALSE, warning=FALSE}
# Adding country districts

shapefile_path <- "C:/Users/aleja/OneDrive/Escritorio/Term_2/Geospatial/Homework_1/paper_1/Country/gadm41_ZAF_3.shp"
# Load the shapefile
shp_data <- st_read(shapefile_path)

# Adding Dams

dam_path <- "C:/Users/aleja/OneDrive/Escritorio/Term_2/Geospatial/Homework_1/paper_1/Dams/GDW_barriers_v1_0.shp"
shp_dam_data <- st_read(dam_path)
# Filter the sf object for South Africa
shp_dam_data_filtered <- shp_dam_data[shp_dam_data$COUNTRY == "South Africa", ]

# Adding River Gradients

river_path <- "C:\\Users\\aleja\\OneDrive\\Escritorio\\Term_2\\Geospatial\\Homework_1\\paper_1\\Rivers\\HydroRIVERS_v10_af.shp"
shp_river_data <- st_read(river_path)
# Transform all layers to  WGS 84)
shp_data <- st_transform(shp_data, crs = 4326)
shp_dam_data_filtered <- st_transform(shp_dam_data_filtered, crs = 4326)
shp_river_data <- st_transform(shp_river_data, crs = 4326)
# Filter river data
# We couldn't find River Gradient data so we will be using river flow as a proxy
# Creating a bounding box to improve code speed (via filtering)
# Define the bounding box for South Africa
south_africa_bbox <- st_bbox(c(xmin = 16.45, ymin = -34.84, xmax = 32.89, ymax = -22.13), crs = 4326)
# Crop the river data using the bounding box
filtered_rivers <- st_crop(shp_river_data, south_africa_bbox)
# Simplify the geometry of filtered_rivers
# We simplify the geometry here in order to improve code speed
filtered_rivers_simplified <- st_simplify(filtered_rivers, dTolerance = 0.1)
# Perform spatial join with simplified rivers
shp_with_rivers <- st_join(shp_data, filtered_rivers_simplified, join = st_intersects)
# Calculate average ORD_FLOW grouped by NAME_3 (District Name)
average_ord_flow <- shp_with_rivers %>%
  st_drop_geometry() %>%  # Drop geometry to speed up summarization
  group_by(NAME_3) %>%
  summarize(avg_ord_flow = mean(ORD_FLOW, na.rm = TRUE))
# Merge the average ORD_FLOW back into shp_data
shp_data <- shp_data %>%
  left_join(average_ord_flow, by = "NAME_3")

# Note: Order flow data indicates the order of the rivers in term of their flows,
# meaning that lower values indicate that a river is classified as having more flow
# thus less order flow in our data = more river gradient (proxy).

##### Figure 1 plot ########

ggplot() +
  # Plot shp_data, filled by avg_ord_flow
  geom_sf(data = shp_data, aes(fill = avg_ord_flow), color = "black", size = 0.1) +
  
  # Plot dam data
  geom_sf(data = shp_dam_data_filtered, size = 0.7, color="blue", fill = "blue") +
  
  # Color scale for avg_ord_flow
  scale_fill_viridis_c(
    option = "plasma",
    begin = 0.1,
    na.value = "grey90") +
  
  # Add labels and theme
  labs(
    fill = "District Order River Flow",
    caption = "Notes: Each light blue dot indicates the location of a dam. The shading
    reflects the average river flow within the district"
  ) +
  theme_minimal()+
  theme(
    axis.title = element_blank(),    # Remove axis titles
    axis.text = element_blank(),     # Remove axis text (tick labels)
    axis.ticks = element_blank(),    # Remove axis ticks
    panel.grid = element_blank()     # Remove grid lines
  )
```

## Districts and electricity grid in Ethiopia

From [@fried2021].

```{r setup, message=FALSE, warning=FALSE}

# Adding Country districts shapefile
shapefile_path_figure2 <- "C:/Users/aleja/OneDrive/Escritorio/Term_2/Geospatial/Homework_1/paper_2/country/gadm41_ETH_3.shp"
# Load the shapefile
shp_data_eth <- st_read(shapefile_path_figure2)

# Adding Roads
shapefile_path_roads <-  "C:/Users/aleja/OneDrive/Escritorio/Term_2/Geospatial/Homework_1/paper_2/roads_2/Ethiopia_Roads.shp"
# Read the shapefile
roads_data <- st_read(shapefile_path_roads)

# Adding Population data
# Define the file path
file_path <- "C:/Users/aleja/OneDrive/Escritorio/Term_2/Geospatial/Homework_1/paper_2/population/eth_admpop_2023.xlsx"
# Read the specific sheet
data_adm3 <- read_excel(file_path, sheet = "ETH_admpop_adm3_2023")

#We couldn't find a shape file with population per district included, so here we
# are merging the shp data set with data_adm3 which contains per district population
# data. We also handle missing values.

# Create the new column CC_3 by extracting numbers after 'ET' in the admin3Pcode column
data_adm3 <- data_adm3 %>%
  mutate(CC_3 = gsub("ET", "", admin3Pcode))
# Merge the Total column from data_adm3 into shp_data_eth using CC_3 as the key
shp_data_eth <- shp_data_eth %>%
  left_join(data_adm3 %>% select(CC_3, Total), by = "CC_3")

#Creating population density
# In order to get population density we use st_area() function to get the total
# area of the district.
# Calculate area in square kilometers
shp_data_eth$area_km2 <- as.numeric(st_area(shp_data_eth) / 1e6)
# Create the population density column
shp_data_eth$population_density <- shp_data_eth$Total / shp_data_eth$area_km2
# Handling missing
shp_data_eth$population_density[is.na(shp_data_eth$population_density)] <- 0


# Adding Electricity data
# Define the file path
file_path <- "C:/Users/aleja/OneDrive/Escritorio/Term_2/Geospatial/Homework_1/paper_2/electricity_grid/Ethiopia Electricity Transmission Network.shp"
# Read the shapefile
ethiopia_grid <- st_read(file_path)
# Calculate intersections of red lines (to add bolts)
intersections <- st_intersection(ethiopia_grid)

# Plot the map
ggplot() +
  # Add the Ethiopia shapefile with fill based on population density
  geom_sf(data = shp_data_eth, aes(fill = population_density), color = "gray80") +
  
  # Add the electricity transmission network (red lines)
  geom_sf(data = ethiopia_grid, color = "red", size = 4) +
  
  # Add lightning bolts at intersections (red)
  geom_sf(data = intersections, color = "red", size = 3, shape = "\u26A1") +  # Unicode for ⚡ symbol
  
  # Add the roads data as an overlay with black lines
  geom_sf(data = roads_data, color = "black", size = 5) +
  
  # Set a minimal theme
  theme_minimal() +
  
  # Add a sequential color scale with limits set to 0–300
  scale_fill_gradient(
    low = "lightblue", 
    high = "darkblue", 
    name = "Population Density\n(people/km²)",
    limits = c(0, 300),    # Set the gradient range between 0 and 300
    oob = scales::squish  # Squeeze values > 300 into the max color
  ) +
  
  # Add labels and improve visualization
  labs(
    caption = "Source: GADM.org, OCHA and World Bank data"
  ) +
  
  # Customize the theme for better aesthetics
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(size = 10, face = "italic"),
    legend.position = "none",  # Remove legend
    axis.text = element_blank(),         # Remove axis text
    axis.ticks = element_blank(),        # Remove axis ticks
    axis.title = element_blank(),
    panel.grid = element_blank()     
  )
```

## Population in Brazil’s meso-regions

From [@pellegrina2021].

#installing required packages
library(geobr)      
library(sf)         
library(ggplot2)    
library(dplyr)      
library(tidyverse)  
library(readxl)     

# Loading census data obtained online for the requried years (ibge.gov.br)
file_path <- "census_data.xlsx"
df <- read_excel(file_path, sheet = 1)

# Checking column names
colnames(df)

# Renaming for consistency
df <- df %>%
  rename(name_state= Region)

head(df)

# Loading Meso-Region boundaries using geobr package (geo-spatial data) 
brazil_map <- read_meso_region(year = 2010)  # Most recent meso-region boundaries
head(brazil_map)

# Aggregating meso-regions to the state level for simplicity
brazil_states <- brazil_map %>%
  group_by(name_state) %>%
  summarise(geom = st_union(geom)) %>%
  left_join(df, by = "name_state")  # Merge with population data

head(brazil_states)

# Define North & Central-West states as "West"
west_states <- c("Amazonas", "Pará", "Acre", "Amapá", "Roraima", "Rondônia", "Tocantins",
                 "Mato Grosso", "Mato Grosso do Sul", "Goiás", "Distrito Federal")

# Extract only the "West" meso-regions (as done in paper)
west_map <- brazil_map %>%
  filter(name_state %in% west_states) %>%
  group_by(name_state) %>%
  summarise(geom = st_union(geom))

colnames(brazil_states)

#plotting maps
plot_map <- function(year) {
  ggplot() +
    geom_sf(data = brazil_states, aes(fill = .data[[year]]), color = "black") +  
    geom_sf(data = west_map, fill = NA, color = "red", size = 1) +  # Red contour for "West"
    scale_fill_gradient(low = "lightblue", high = "blue", na.value = "white") +  # Light for low, dark for high
    labs(title = paste("Population Distribution in", year),
         fill = "Population") +
    theme_minimal()
}

print(plot_map("1950"))
print(plot_map("1980"))
print(plot_map("2010"))


## Vietnam’s road infrastructure by road type

From [@balboni2019].








## Brazil’s capital and main road infrastructure

The next figure is a map of the Brazilian road network indicating Brasilia and the 26 state capitals ([@morten2018]). It shows the highway network in 2000 separating radial highways from nonradial highways.

```{r data-load, message=FALSE, warning=FALSE}
sink(tempfile()) 

# Location of each state
states <- st_read(file.path(path_data,"/p5/data/gis_data/uf1940/uf1940_prj.shp"))
sf.states  <- rmapshaper::ms_simplify(states, keep=0.01, keep_shapes=TRUE)

# Information about roads
year  <- 2000
file_name = paste0(path_data, "/p5/data/gis_data/roads/", year,"/highways_", year, "_prj.shp")
all_highways <- st_read(file_name)
sf.roads  <- rmapshaper::ms_simplify(all_highways, keep=0.01, keep_shapes=TRUE)

# Minimum spanning tree (mst_pie)
mst_pie <- st_read(file.path(path_data, "/p5/data/gis_data/mst/mst_pie_prj.shp"))
sf.mst  <- rmapshaper::ms_simplify(mst_pie, keep=0.01, keep_shapes=TRUE)

# Cities in Brazil
capital_cities <- st_read(file.path(path_data,"/p5/data/gis_data/cities/brazil_capital_cities_prj.shp"))
cities_xy <- cbind(capital_cities, st_coordinates(capital_cities))

sink() 

# Figure
ggplot() +
  geom_sf(data=sf.states, fill="white", color="grey90") +
  geom_sf(data=sf.mst, size=.8, linetype = "11", aes(color = "Minimum spanning tree"), show.legend = "line")   +
  geom_sf(data=sf.roads %>% filter(dm_anlys_p==1 & dm_radial==0), size=.6, linetype = "dashed", aes(color = "Non-radial highways (2000)"), show.legend = "line") +
  geom_sf(data=sf.roads %>% filter(dm_anlys_p==1 & dm_radial==1), size=.9, aes(color = "Radial highways (2000)"), show.legend = "line") +
  theme_minimal() +
  no_axis +
  geom_point(data=cities_xy,aes(x=X,y=Y)) +
  geom_text_repel(data=cities_xy,aes(x=X,y=Y,label=CITY_NAME)) +
  labs(color = " ") +
  scale_color_manual(values=c("#777676","#868686","#565555"),
                     guide = guide_legend(override.aes = list(linetype = c("11", "dashed", "solid"))))
```

# References

# Figure 1

#Shape of Country with districts: <https://gadm.org/download_country.html>

#Dam data: <https://www.globaldamwatch.org/database>

#River Order Flow: <https://www.hydrosheds.org/products/hydrorivers>

# Figure 2

#Shape of Country with districts: <https://gadm.org/download_country.html>

#Roads: <https://datacatalog.worldbank.org/search/dataset/0039933/Ethiopia-Roads>

#Population: <https://data.humdata.org/dataset/cod-ps-eth>

#Electricity Grid: <https://datacatalog.worldbank.org/search/dataset/0039311>

# Figure 3

#Census data: https://www.ibge.gov.br/en/statistics/social/population/18391-2010-population-census.html?edicao=19729&t=downloads

# Figure 5
#https://www.openicpsr.org/openicpsr/project/183316/version/V1/view?path=/openicpsr/183316/fcr:versions/V1/Data/GIS_data&type=folder
